<!DOCTYPE html>
<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      layout:decorator="layouts/site"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"
      xmlns:layout="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <title>UMSpreadsheet</title>

    <link rel="stylesheet" th:href="@{/css/show.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/9.7.2/css/bootstrap-slider.min.css" />

</head>

<body>
    <div layout:fragment="content">
        <div id="#home-container" class="container">

            <div id="most-recent-show-header" th:object="${show}">
                <h2 id="show-title" th:text="${#dates.format(show.date, 'yyyy/MM/dd') + ' ' + show.city + ', '  + show.state}"></h2>
                <h2 id="show-rating-and-medal" class="pull-right">
                    <i th:if="*{averageRating gt 6.99 and averageRating lt 8}" class="fa fa-trophy" style="color: #CD7F32;" aria-hidden="true"></i>
                    <i th:if="*{averageRating gt 7.99 and averageRating lt 9}" class="fa fa-trophy" style="color: #C0C0C0;" aria-hidden="true"></i>
                    <i th:if="*{averageRating gt 8.99 and averageRating lt 9.5}" class="fa fa-trophy" style="color: #FFD700;" aria-hidden="true"></i>
                    <i th:if="*{averageRating gt 9.49}" class="fa fa-diamond" style="color: #B9F2FF;" aria-hidden="true"></i>
                    <span th:if="*{averageRating != null}" th:text="*{#numbers.formatDecimal(averageRating, 1, 2)}">[0.00]</span>
                    <span th:if="*{averageRating == null}">No Rating</span>
                </h2>
                <h3 th:text="${show.venue}"></h3>
                <p id="addSet" sec:authorize="hasRole('ROLE_ADMIN')"><a href="javascript:;" onclick="showSetForm();">Add set</a></p>
                <form sec:authorize="hasRole('ROLE_ADMIN')" th:action="@{/admin/add-set}" id="addSetForm"
                      name="addSetForm" th:object="${set}" method="post" style="visibility: hidden;">
                    <input type="hidden" th:field="*{showId}"/>
                    <div class="form-group col-sm-3 col-md-2">
                        <label class="control-label" for="set">Set</label>
                        <input type="text" class="form-control" id="set" th:field="*{name}"/>
                    </div>
                    <div class="form-group col-sm-3 col-md-2 col-lg-1" style="margin-top: 15px; margin-bottom: 0;">
                        <button class="btn btn-lg btn-primary btn-block" type="submit">Add</button>
                    </div>
                </form>
            </div>

            <!--<h2 th:text="${#dates.format(show.date, 'yyyy/MM/dd') + ' ' + show.city + ', '  + show.state}"></h2>
            <h3 th:text="${show.venue}"></h3>-->
            <br/>
            <br/>
            <div th:if="${submitted == 'true'}" class="alert alert-success">
                Review successfully submitted!
            </div>
            <div th:if="${reviewDeleted == 'true'}" class="alert alert-success">
                Review successfully deleted.
            </div>
            <div th:if="${edited == 'true'}" class="alert alert-success">
                Review successfully edited.
            </div>
            <table sec:authorize="isAuthenticated()" class="table table-striped table-condensed show-set-table">
                <thead>
                    <tr>
                        <th class="song-column-header" style="width: 315px">SONG</th>
                        <th class="hidden-xs hidden-sm" style="width: 150px">LENGTH</th>
                        <th class="hidden-xs" style="width: 130px">TYPE</th>
                        <th class="hidden-xs hidden-sm" style="width: 275px">NOTES</th>
                        <th class="hidden-xs" style="width: 175px;">COMMUNITY RATING</th>
                        <th style="width: 280px;">MY RATING</th>
                        <th class="hidden-xs hidden-sm" style="width: 280px;">COMMENTS</th>
                        <th class="hidden-xs"></th>
                    </tr>
                </thead>
                <tbody>
                    <th:block th:each="setEntry : ${trackAndReviewMap}">
                        <tr>
                            <td class="set-title-row" colspan="8" th:text="${setEntry.key}"></td>
                        </tr>
                        <tr th:each="trackAndReviewEntry,iterStat : ${setEntry.value}"
                            th:class="${trackAndReviewEntry.value.id != null}? 'success'">
                            <td>
                                <span th:text="${trackAndReviewEntry.key.song}">[song]</span>
                                <span th:if="${trackAndReviewEntry.key.segue and !iterStat.last}"> > </span>
                                <span th:if="${trackAndReviewEntry.key.fluidSegue}">&nbsp;->&nbsp;</span>
                            </td>
                            <td class="hidden-xs hidden-sm">[length]</td>
                            <td class="hidden-xs">[type]</td>
                            <td class="hidden-xs hidden-sm">[too many notes]</td>
                            <td class="hidden-xs" th:text="${#numbers.formatDecimal(trackAndReviewEntry.key.averageRating, 0, 'COMMA', 2, 'POINT')}">[avg rating]</td>
                            <td>
                                <!--<a th:if="${trackAndReviewEntry.value == null}" th:href="@{/user/review/track(trackId=${trackAndReviewEntry.key.id})}">-->
                                <form th:id="'track' + ${trackAndReviewEntry.key.id} + 'Form'" th:object="${trackReviewForm}"
                                      th:action="@{/shows/show}" method="post">
                                    <input type="hidden" th:if="${trackAndReviewEntry.value.id != null}"
                                           th:value="${trackAndReviewEntry.value.id}" th:name="id" th:id="id" />
                                    <input type="hidden" th:value="${trackAndReviewEntry.value.trackId}" th:name="trackId"
                                           th:id="trackId"/>
                                    <input type="hidden" th:field="*{username}" />
                                    <span th:id="'track' + ${trackAndReviewEntry.key.id} + 'SliderLabel'">0.00</span>
                                    <input th:id="'track' + ${trackAndReviewEntry.key.id}" class="bs-slider"
                                           th:name="score" data-slider-id='trackReviewSlider'
                                           type="number" data-slider-min="0" data-slider-max="10"
                                           data-slider-step="0.25" data-slider-value="0" data-slider-tooltip="hide"/>
                                </form>
                                    <!-- <i class="fa fa-plus" aria-hidden="true" style="color: green;"></i> -->
                                <!--</a>-->
                            </td>
                            <td class="hidden-xs hidden-sm">
                                <a th:if="${trackAndReviewEntry.value != null}" th:href="@{/user/review/track(reviewId=${trackAndReviewEntry.value.id})}">
                                    <i class="fa fa-comment-o" aria-hidden="true"></i>
                                </a>
                            </td>
                            <td class="hidden-xs">
                                <form th:if="${trackAndReviewEntry.value.id != null}" th:object="${trackAndReviewEntry.value}"
                                      th:action="@{/shows/show(reviewId=${trackAndReviewEntry.value.id}, showId=${trackAndReviewEntry.key.show.id})}"
                                      th:method="delete" onclick="return confirm('Are you sure you want to delete this review?')">
                                    <button type="submit" class="icon-button">
                                        <i class="fa fa-trash" aria-hidden="true" style="color: #B33A3A"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        <p id="addTrack" sec:authorize="hasRole('ROLE_ADMIN')"><a href="javascript:;" onclick="showSetForm();">Add song</a></p>
                        <form sec:authorize="hasRole('ROLE_ADMIN')" th:action="@{/admin/add-track}" id="addSetForm"
                              name="addSetForm" th:object="${track}" method="post" style="visibility: hidden;">
                            <input type="hidden" th:field="*{showId}"/>
                            <input type="hidden" th:value="" th:field="*{setId}"/>
                            <div class="form-group col-sm-3 col-md-2">
                                <label class="control-label" for="set">Set</label>
                                <input type="text" class="form-control" id="set" th:field="*{name}"/>
                            </div>
                            <div class="form-group col-sm-3 col-md-2 col-lg-1" style="margin-top: 15px; margin-bottom: 0;">
                                <button class="btn btn-lg btn-primary btn-block" type="submit">Add</button>
                            </div>
                        </form>
                    </th:block>
                </tbody>
            </table>

            <table sec:authorize="isAnonymous()" class="table table-striped table-condensed show-set-table">
                <!--<h4 class="set-name" th:text="${setEntry.key}">Set 1</h4>-->
                <thead>
                <tr>
                    <th style="width: 315px">SONG</th>
                    <th class="hidden-xs" style="width: 150px">LENGTH</th>
                    <th style="width: 130px">TYPE</th>
                    <th class="hidden-xs" style="width: 275px">NOTES</th>
                    <th style="width: 175px;">COMMUNITY RATING</th>
                </tr>
                </thead>
                <tbody>
                    <th:block th:each="setEntry : ${trackAndReviewMap}">
                        <tr>
                            <td class="set-title-row" colspan="5" th:text="${setEntry.key}"></td>
                        </tr>
                        <tr th:each="trackAndReviewEntry,iterStat : ${setEntry.value}">
                            <td>
                                <span th:text="${trackAndReviewEntry.key.song}">[song]</span>
                                <span th:if="${trackAndReviewEntry.key.segue and !iterStat.last}"> > </span>
                                <span th:if="${trackAndReviewEntry.key.fluidSegue}">&nbsp;->&nbsp;</span>
                            </td>
                            <td class="hidden-xs">[length]</td>
                            <td>[type]</td>
                            <td class="hidden-xs">[too many notes]</td>
                            <td th:text="${#numbers.formatDecimal(trackAndReviewEntry.key.averageRating, 0, 'COMMA', 2, 'POINT')}">[avg rating]</td>
                        </tr>
                    </th:block>
                </tbody>
            </table>

            <table id="user-reviews" class="table table-striped table-condensed">
                <thead>
                    <tr>
                        <th>USER</th>
                        <th>SONG</th>
                        <th>RATING</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="review : ${allReviews}" th:object="${review}">
                        <td th:text="*{user.username}">[user]</td>
                        <td th:text="*{track.song}">[song]</td>
                        <td th:text="*{score}">[rating]</td>
                    </tr>
                </tbody>
            </table>

        </div>
    </div>

    <th:block layout:fragment="script">
        <script type="text/javascript" th:inline="javascript">

            var trackIdMap = [[${trackIdMap}]];

            Object.keys(trackIdMap).forEach(function (key)
            {
                createSlider(key, trackIdMap[key])
            });

            function createSlider(trackId, score) {
                var mySlider = $('#track' + trackId).bootstrapSlider({
                    formatter: function (value) {
                        return 'Current value: ' + value;
                    }
                });

                if (score != null) {
                    mySlider.bootstrapSlider('setValue', score);
                    $('#track' + trackId + 'SliderLabel').text(parseFloat(Math.round(score * 100) / 100).toFixed(2));
                }
            }

            $(document).ready(function()
            {
                $(".bs-slider").on("slide", function (slideEvt)
                {
                    $('#' + slideEvt.target.id + 'SliderLabel').text(parseFloat(Math.round(slideEvt.value * 100) / 100).toFixed(2));
                });

                $(".bs-slider").on("slideStop", function (slideEvt)
                {
                    $('#' + slideEvt.target.id + 'Form').submit();
                });
            });


            function showSetForm(event)
            {
                var addSetPElement = document.getElementById("addSet");
                addSetPElement.outerHTML = "";
                delete addSetPElement;
                document.getElementById("addSetForm").style.visibility = "visible";
            }
        </script>
    </th:block>
</body>
</html>